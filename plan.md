# خطة محكمة لحل مشكلة "لم يتم العثور على ولي الأمر بهذا الكود"

هذا المستند يوضح الخطة النهائية لحل مشكلة ربط الطالب بولي الأمر بشكل جذري ومستقر.

## 1. تحليل المشكلة

المشكلة تظهر لأن الكود الذي يدخله الطالب لا يتطابق مع أي كود موجود في قاعدة البيانات. بعد التحقيقات السابقة، تبين أن السبب الجذري ليس في منطق الكود الحالي، بل في **حالة البيانات** و**توحيدها**.

- **المنطق الحالي (صحيح):**
    1.  عند إنشاء كود ولي الأمر، يتم تحويله إلى **أحرف كبيرة (UPPERCASE)** وحفظه.
    2.  عندما يبحث الطالب عن الكود، يتم تحويل ما أدخله إلى **أحرف كبيرة (UPPERCASE)** ثم تتم المقارنة.
- **سبب المشكلة المتبقية:**
    - وجود أكواد قديمة في قاعدة البيانات لم يتم إنشاؤها بأحرف كبيرة.
    - عندما يبحث النظام عن كود قديم (مثلاً `p-abcDEF`) بتحويله إلى `P-ABCDEF`، لا يجده لأن البحث دقيق وحساس لحالة الأحرف.

## 2. خطة الحل (من ثلاثة محاور)

لحل المشكلة نهائياً، يجب العمل على ثلاثة محاور: **البيانات**، **الكود**، و**تجربة المستخدم**.

### المحور الأول: تصحيح البيانات القديمة (الأولوية القصوى)

هذه هي أهم خطوة. يجب علينا تحديث جميع `parentCode` الحالية في قاعدة البيانات لتكون بأحرف كبيرة. هذا سيجعل قاعدة البيانات بأكملها متوافقة مع منطق الكود الحالي.

**الإجراء:**
1.  **إنشاء سكربت تحديث:** سيتم إنشاء سكربت Prisma جديد باسم `prisma/normalize-parent-codes.ts`.
2.  **وظيفة السكربت:** سيقوم السكربت بالمرور على كل المستخدمين الذين لديهم `parentCode` وتحديثه إلى صيغة الأحرف الكبيرة.
3.  **تنفيذ السكربت:** يجب تشغيل هذا السكربت **لمرة واحدة فقط** على قاعدة البيانات الإنتاجية.

### المحور الثاني: تحسين الكود لتقديم ملاحظات أفضل

الكود الحالي يعرض رسالة خطأ واحدة. يمكننا تحسينها لتكون أوضح للمستخدم.

**الإجراء:**
1.  **التعديل على `src/app/(main)/profile/page.tsx` (أو الملف المسؤول عن الواجهة):**
    - قبل إرسال الطلب إلى الواجهة الخلفية، يتم التحقق من صيغة الكود المدخل.
    - إذا كان الكود لا يتبع النمط المتوقع (مثلاً، لا يبدأ بـ `P-` أو طوله غير صحيح)، يتم عرض رسالة خطأ فورية للمستخدم مثل: "صيغة الكود غير صحيحة. يجب أن تكون مشابهة لـ P-XXXXXX".
    - تحويل الكود إلى أحرف كبيرة في الواجهة الأمامية قبل إرساله.

### المحور الثالث: توجيه المستخدم (User Guidance)

يجب مساعدة المستخدمين على فهم كيفية استخدام الميزة بشكل صحيح.

**الإجراء:**
1.  **تعديل واجهة إدخال الكود:**
    - إضافة نص مساعد (placeholder) واضح في حقل الإدخال يوضح شكل الكود، مثال: `P-ABC123`.
    - إضافة ملاحظة نصية صغيرة تحت حقل الإدخال: "ملاحظة: سيتم تحويل الكود إلى أحرف كبيرة تلقائيًا."

## 3. خطوات التنفيذ

1.  **[✔] (مكتمل)** **كتابة الخطة:** إنشاء هذا الملف `plan.md`.
2.  **[ ]** **إنشاء سكربت التحديث:** كتابة الكود لملف `prisma/normalize-parent-codes.ts`.
3.  **[ ]** **إعلام مدير النظام:** إبلاغ مدير النظام بضرورة تشغيل السكربت بعد إنشائه.
4.  **[ ]** **تحسين الواجهة الأمامية:** تطبيق التحسينات على واجهة المستخدم في صفحة الملف الشخصي للطالب.
5.  **[ ]** **المراجعة النهائية:** التأكد من أن جميع أجزاء النظام (الإنشاء، البحث، التحديث) تتبع نفس القاعدة الموحدة (UPPERCASE).

بتنفيذ هذه الخطة، نضمن أن المشكلة لن تظهر مجدداً لأي مستخدم جديد، وسيتم تصحيح وضع المستخدمين القدامى.
